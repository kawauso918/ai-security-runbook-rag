# AIセキュリティ運用手順書アシスタント（RAG）

**SOC運用×業務系RAGシステム。手順書を検索して質問に回答します。**

[![Streamlit App](https://static.streamlit.io/badges/streamlit_badge_black_white.svg)](https://your-app-url.streamlit.app)
<!-- デプロイ後、上記URLを実際のStreamlit CloudのURLに置き換えてください -->

## 📌 概要（1分で理解）

セキュリティ運用チーム向けの**RAG（Retrieval-Augmented Generation）ベース質問応答システム**です。

**できること:**
- 📄 手順書（PDF/Markdown）をアップロード
- 🔍 質問を入力すると、関連する手順を検索して回答
- 📚 回答の根拠（引用元）を明示
- ⚠️ 危険操作を検知して警告

**特徴:**
- ハイブリッド検索（BM25 + ベクトル検索）で高精度な情報取得
- 根拠不足の場合は固定応答で誤情報を防止
- 監査用ログ記録・評価機能を搭載

## 🎯 主な機能

### 1. RAG回答＋引用表示
- 質問に対して、手順書から関連情報を検索して回答
- 回答の根拠となった手順書のセクションを引用として表示
- 「どのファイルの、どのセクションから」が明確

### 2. ハイブリッド検索（BM25 + Vector）
- **BM25検索**: キーワードマッチング（デフォルト重み: 0.6）
- **ベクトル検索**: 意味的類似度（デフォルト重み: 0.4）
- UIから重みを調整可能（リアルタイム反映）

### 3. 根拠不足時の固定応答
- 検索スコアが閾値（0.5）未満の場合、「該当する手順が見つかりませんでした」と返答
- LLMの幻覚（ハルシネーション）を防止

### 4. 危険操作検知
- 「削除」「消去」「停止」などのキーワードを検知
- 警告バナーを表示して慎重な操作を促す

### 5. PDF見出し推定→セクション化
- pypdfでPDFからテキスト抽出
- フォントサイズ・太字などから見出しを推定
- 自動的にセクションに分割して検索精度を向上

### 6. 会話履歴（5往復）
- セッション内で直近5往復の会話を保持
- 文脈を考慮した回答が可能
- トークン数の爆発を防止

### 7. ログ記録・評価
- **ログ記録**: JSONL形式で質問・回答・スコア・コストを記録
- **LLM as a Judge評価**: 回答品質を自動評価（根拠性・正確性・網羅性など）

### 8. ファイルアップロード機能
- ブラウザから直接PDF/Markdown/テキストをアップロード
- 複数ファイル一括アップロード対応
- アップロード後、自動的にインデックスを構築

## 🚀 デモ

<!-- デプロイ後、スクリーンショットやGIFを追加 -->
<!-- ![デモ画面](./images/demo.png) -->

**Live Demo:** [Streamlit Cloud](https://your-app-url.streamlit.app)
<!-- デプロイ後、URLを更新してください -->

## 🛠️ 技術スタック

- **UI**: Streamlit
- **RAGフレームワーク**: LangChain
- **ベクトルDB**: ChromaDB
- **検索**: BM25 (rank-bm25) + ベクトル検索
- **LLM**: OpenAI API (gpt-4o-mini)
- **Embeddings**: OpenAI Embeddings (text-embedding-ada-002)
- **日本語処理**: Sudachi

## 📦 セットアップ（ローカル環境）

### 1. リポジトリのクローン

```bash
git clone https://github.com/kawauso918/ai-security-runbook-rag.git
cd ai-security-runbook-rag
```

### 2. 仮想環境の作成と有効化

```bash
python3 -m venv .venv
source .venv/bin/activate  # macOS/Linux
# または
.venv\Scripts\activate  # Windows
```

### 3. 依存パッケージのインストール

```bash
pip install -r requirements.txt
```

**注意**: Sudachi辞書のダウンロードが必要な場合があります：
```bash
python -c "import sudachipy; sudachipy.Dictionary().create()"
```

### 4. 環境変数の設定

`.env.example`をコピーして`.env`を作成し、OpenAI APIキーを設定：

```bash
cp .env.example .env
```

`.env`ファイルを編集：
```env
OPENAI_API_KEY=your_openai_api_key_here
```

### 5. アプリケーションの起動

```bash
streamlit run main.py
```

ブラウザで `http://localhost:8501` が開きます。

## 📚 使い方

### 初回起動時

1. **手順書のアップロード**:
   - サイドバーの「📤 手順書アップロード」から、PDF/Markdown/テキストファイルをアップロード
   - 複数ファイルを一度に選択可能
   - 自動的にインデックスが構築されます

2. **質問の入力**:
   - メインエリアのチャット入力欄に質問を入力
   - 例: 「インシデント発生時の初動対応手順は？」

3. **回答の確認**:
   - 回答と引用元が表示されます
   - 引用元は「📚 引用元」の折りたたみUIで確認可能

### サイドバー設定

- **検索結果数 (k)**: 検索結果として取得するチャンク数（デフォルト: 4）
- **BM25重み**: BM25検索の重み（デフォルト: 0.6）
- **ベクトル重み**: ベクトル検索の重み（自動計算: 1.0 - BM25重み）
- **外部検索**: 手順書に該当情報がない場合に外部検索を許可

## 📁 データの扱い

### デモデータのみ使用

このリポジトリには**デモ用の小さなMarkdownファイル**のみが含まれています：
- `data/sample_manual.md`: サンプル手順書
- `data/incident_response.md`: インシデント対応手順書

### 機密情報の入力禁止

⚠️ **このシステムに機密情報（パスワード、APIキー、個人情報など）を入力しないでください。**

- 入力された質問と回答はログに記録されます
- ログは監査目的で保存されます
- 本番環境で使用する場合は、適切なアクセス制御を実装してください

### PDFファイルについて

- **リポジトリには含まれていません**（`.gitignore`で除外）
- ローカル環境では`data/`フォルダに配置可能
- アプリ内のアップロード機能を利用することを推奨

## ⚠️ 制約・注意事項

### 現在の制約

- **OCR未対応**: スキャン画像のみのPDFはテキスト抽出できません
- **パスワード保護PDF**: 読み込めません
- **大容量ファイル**: 数百MBを超えるファイルは処理に時間がかかります
- **言語**: 主に日本語に最適化（Sudachi使用）

### トラブルシューティング

詳細は[トラブルシューティング](#トラブルシューティング)セクションを参照してください。

## 🔮 今後の拡張案

### 短期的な改善

- [ ] **OCR対応**: スキャンPDFからテキスト抽出（Tesseract、Azure Document Intelligence等）
- [ ] **Re-ranking**: 検索結果の再ランキングで精度向上（Cohere Rerank、LLM-based reranking）
- [ ] **チャンクサイズ最適化**: ドキュメントタイプに応じた適応的なチャンキング

### 中期的な改善

- [ ] **ユーザー認証・権限制御**: 組織ごとのアクセス制御
- [ ] **マルチテナント対応**: 複数チームでの利用
- [ ] **外部ストレージ連携**: S3、Google Cloud Storage等からのファイル読み込み
- [ ] **検索履歴・推薦機能**: よく検索される質問を推薦

### 長期的な改善

- [ ] **マルチモーダル対応**: 図表・画像の認識と説明
- [ ] **ドメイン特化Fine-tuning**: セキュリティ用語に特化したモデル
- [ ] **エージェント機能**: 複数の手順書を横断した自律的な情報収集

## 📊 評価

### LLM as a Judge評価

システムの回答品質を自動評価する機能です。

1. **評価実行**: サイドバーから「📊 評価を実行」をクリック
2. **評価基準**:
   - 根拠性: 回答が引用元に基づいているか
   - 正確性: 技術的に正確な情報か
   - 網羅性: 必要な情報が含まれているか
   - 安全性: 危険操作への警告が適切か
   - 引用明示: 引用が適切に表示されているか
   - 簡潔性: 冗長でないか

3. **合格ライン**: 10問中7問以上が平均70点以上

## 📝 ログと監査

### ログファイル

- **保存先**: `logs/query_YYYY-MM-DD.jsonl`
- **形式**: JSONL（1行1エントリ）
- **内容**:
  - タイムスタンプ
  - セッションID
  - 質問と回答
  - 検索結果（スコア、引用元）
  - 処理時間（latency_ms）
  - トークン使用量とコスト
  - 警告理由（warning_reason）

### ログの確認方法

```bash
# 今日のログを確認
cat logs/query_$(date +%Y-%m-%d).jsonl | jq .

# 特定の日付のログを確認
cat logs/query_2024-12-29.jsonl | jq .
```

## 🗂️ ファイル構成

```
ai-security-runbook-rag/
├── main.py              # Streamlitメインアプリ
├── initialize.py        # インデックス構築
├── retriever.py         # ハイブリッド検索
├── guardrails.py        # ガードレール（危険操作検知等）
├── logger.py            # ログ記録
├── components.py        # UIコンポーネント
├── utils.py             # ユーティリティ関数
├── constants.py         # 定数定義
├── error_handler.py     # エラーハンドリング
├── judge.py             # 評価処理
├── requirements.txt     # 依存パッケージ
├── runtime.txt          # Python バージョン指定
├── .env.example         # 環境変数テンプレート
├── .gitignore
├── .gitattributes       # Git LFS設定
├── data/                # 手順書ファイル格納フォルダ
│   ├── README.md        # データ管理ガイド
│   ├── sample_manual.md
│   └── incident_response.md
├── logs/                # ログファイル（JSONL形式）
│   └── query_YYYY-MM-DD.jsonl
├── eval/                # 評価データ
│   ├── eval_dataset.json
│   └── evaluation_results_YYYY-MM-DD.json
└── chroma_db/           # ChromaDBデータ（自動生成）
```

## 🔧 トラブルシューティング

### データフォルダが空の場合

**エラー**: `データフォルダにファイルが見つかりません`

**対応**:
1. `data/`フォルダに手順書ファイルを配置
2. ファイル形式を確認（`.md`, `.txt`, `.pdf`）
3. インデックス再構築を実行

### PDFファイルが読めない場合

**エラー**: `PDF読み込みエラー`

**対応**:
1. PDFファイルが破損していないか確認
2. パスワード保護されていないか確認
3. テキスト抽出可能なPDFか確認（スキャン画像のみのPDFは非対応）
4. Markdown形式に変換して再試行

### インデックスが構築されていない場合

**エラー**: `インデックスが構築されていません`

**対応**:
1. サイドバーから「🔄 インデックス再構築」を実行
2. データフォルダにファイルが存在するか確認

### API呼び出しエラー

**エラー**: `API呼び出しエラー`

**対応**:
1. `.env`ファイルで`OPENAI_API_KEY`が正しく設定されているか確認
2. ネットワーク接続を確認
3. APIキーの有効性を確認
4. レート制限に達していないか確認（しばらく待ってから再試行）

### 処理時間が長い場合

**警告**: `処理時間が5秒を超過しました`

**対応**:
- 検索結果数(k)を減らす
- データ量が多い場合はチャンクサイズを調整
- ネットワーク状況を確認

## 📄 ライセンス

MIT License

## 🙏 謝辞

このプロジェクトは、セキュリティ運用の効率化を目的として開発されました。

---

**開発者**: [@kawauso918](https://github.com/kawauso918)

**リポジトリ**: [ai-security-runbook-rag](https://github.com/kawauso918/ai-security-runbook-rag)

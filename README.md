# AIセキュリティ運用手順書アシスタント（RAG）

SOC運用×業務系RAGシステム。手順書を検索して質問に回答します。

## MVP（Minimum Viable Product）

**手順書PDF/MDをアップロード → 検索 → 回答＋引用（根拠）**

- ブラウザから直接PDF/Markdown/テキストファイルをアップロード可能
- アップロード後、自動的にインデックスを構築
- 質問に対して回答と根拠（引用元）を提示

## 強み

**RAGの基本に「運用に耐えるUI/引用/ログ」を追加**

- 📤 **運用に耐えるUI**: ファイルアップロード、検索設定、引用の折りたたみ表示
- 📚 **引用表示**: 回答の根拠となった手順書のセクションを明示
- 📝 **ログ記録**: JSONL形式で質問・回答・処理時間・コストを監査用に記録
- ⚠️ **ガードレール**: 危険操作検知、根拠不足判定、レイテンシ監視

## 機能

- **ハイブリッド検索**: BM25 + ベクトル検索の組み合わせ
- **根拠不足判定**: 検索スコアが低い場合は「該当する手順が見つかりませんでした」と返答
- **危険操作検知**: 削除・消去などの危険な操作を含む場合は警告を表示
- **会話履歴**: セッション内で5往復の会話を保持（トークン爆発防止）
- **ログ記録**: JSONL形式でログを記録（監査用）
- **レイテンシ監視**: 処理時間が5秒を超過した場合に警告表示

## ⚠️ 重要な注意事項

### 機密情報の入力禁止

**このシステムに機密情報（パスワード、APIキー、個人情報など）を入力しないでください。**

- 入力された質問と回答はログに記録されます
- ログは監査目的で保存されます
- 機密情報が含まれる可能性のある質問は避けてください

## セットアップ

### 1. リポジトリのクローン

```bash
git clone <repository-url>
cd ai-security-runbook-rag
```

### 2. 仮想環境の作成と有効化

```bash
python3 -m venv .venv
source .venv/bin/activate  # macOS/Linux
# または
.venv\Scripts\activate  # Windows
```

### 3. 依存パッケージのインストール

```bash
pip install -r requirements.txt
```

**注意**: Sudachi辞書のダウンロードが必要な場合があります：
```bash
python -c "import sudachipy; sudachipy.Dictionary().create()"
```

### 4. 環境変数の設定

`.env.example`をコピーして`.env`を作成し、OpenAI APIキーを設定：

```bash
cp .env.example .env
```

`.env`ファイルを編集：
```env
OPENAI_API_KEY=your_openai_api_key_here
```

### 5. データの準備

`data/`フォルダに手順書ファイル（PDF/Markdown/テキスト）を配置します。

**サポート形式**:
- Markdown (`.md`)
- テキスト (`.txt`)
- PDF (`.pdf`) - pypdfが必要

**サンプルデータ**:
- `data/sample_manual.md`
- `data/incident_response.md`

## 起動方法

```bash
streamlit run main.py
```

ブラウザで `http://localhost:8501` が開きます。

## 使い方

### 初回起動時

1. **データフォルダの確認**: サイドバーで`data/`フォルダのパスを確認
2. **手順書のアップロード**（推奨）:
   - サイドバーの「📤 手順書アップロード」セクションから、PDF/Markdown/テキストファイルをアップロード
   - 複数ファイルを一度に選択可能
   - 「アップロード実行」ボタンをクリック
   - 「アップロード後に自動的にインデックスを再構築」にチェックが入っていれば、自動的にインデックスが構築されます
3. **手動でのインデックス構築**（代替手段）:
   - `data/`フォルダに手順書ファイルを手動で配置
   - サイドバーから「🔄 インデックス再構築」ボタンをクリック
   - 処理中はプログレスバーが表示されます
   - 完了するとチャンク数が表示されます

### 日常利用

1. **質問入力**: メインエリアのチャット入力欄に質問を入力
2. **回答確認**:
   - 回答が表示されます
   - 引用元は「📚 引用元」の折りたたみUIで確認できます
   - 危険操作が検知された場合は警告バナーが表示されます
3. **手順書の追加**:
   - サイドバーの「📤 手順書アップロード」から新しいファイルをアップロード
   - または`data/`フォルダに直接配置して「🔄 インデックス再構築」を実行

### サイドバー設定

- **データフォルダパス**: 手順書ファイルを格納しているフォルダのパス（デフォルト: `./data`）
- **検索結果数 (k)**: 検索結果として取得するチャンク数（デフォルト: 4、範囲: 1-20）
- **BM25重み**: BM25検索の重み（デフォルト: 0.6、範囲: 0.0-1.0）
- **ベクトル重み**: ベクトル検索の重み（自動計算: 1.0 - BM25重み）

## データ追加方法

### 手順書ファイルの追加

**方法1: ブラウザからアップロード（推奨）**

1. サイドバーの「📤 手順書アップロード」セクションを開く
2. 「PDF/Markdown/テキストファイルをアップロード」をクリック
3. ファイルを選択（複数選択可能）
   - Markdown形式推奨（`.md`）
   - 見出し（`#`, `##`, `###`）でセクション分割されていると検索精度が向上
4. 「アップロード実行」ボタンをクリック
5. 自動的にインデックスが構築されます（オプション有効時）

**方法2: 手動でファイルを配置**

1. `data/`フォルダに新しいファイルを配置
   - Markdown形式推奨（`.md`）
   - 見出し（`#`, `##`, `###`）でセクション分割されていると検索精度が向上
2. サイドバーから「🔄 インデックス再構築」を実行
3. インデックス状態でチャンク数が更新されていることを確認

### ファイル形式の推奨事項

**Markdown形式（推奨）**:
```markdown
# セクション1

## サブセクション1.1

本文...
```

**テキスト形式**:
- UTF-8エンコーディング推奨
- 見出しは`#`で始まる行として記述

**PDF形式**:
- パスワード保護されていないPDF
- テキスト抽出可能なPDF（スキャン画像のみのPDFは非対応）

## 評価の実行方法

### LLM as a Judge評価

システムの回答品質を評価する機能です。

1. **評価データセットの準備**: `eval/eval_dataset.json`に評価用の質問を用意
2. **評価実行**: サイドバーから「📊 評価を実行」ボタンをクリック
3. **結果確認**: 
   - MVP合格/不合格が表示されます
   - 詳細結果は折りたたみUIで確認できます
   - 結果は`eval/evaluation_results_YYYY-MM-DD.json`に保存されます

**注意**: 評価実行にはAPIコストがかかります。

### 評価基準

- **根拠性**: 回答が引用元に基づいているか
- **正確性**: 技術的に正確な情報か
- **網羅性**: 必要な情報が含まれているか
- **安全性**: 危険操作への警告が適切か
- **引用明示**: 引用が適切に表示されているか
- **簡潔性**: 冗長でないか

**合格ライン**: 10問中7問以上が平均70点以上

## トラブルシューティング

### データフォルダが空の場合

**エラー**: `データフォルダにファイルが見つかりません`

**対応**:
1. `data/`フォルダに手順書ファイルを配置
2. ファイル形式を確認（`.md`, `.txt`, `.pdf`）
3. インデックス再構築を実行

### PDFファイルが読めない場合

**エラー**: `PDF読み込みエラー`

**対応**:
1. PDFファイルが破損していないか確認
2. パスワード保護されていないか確認
3. テキスト抽出可能なPDFか確認（スキャン画像のみのPDFは非対応）
4. Markdown形式に変換して再試行

### インデックスが構築されていない場合

**エラー**: `インデックスが構築されていません`

**対応**:
1. サイドバーから「🔄 インデックス再構築」を実行
2. データフォルダにファイルが存在するか確認

### API呼び出しエラー

**エラー**: `API呼び出しエラー`

**対応**:
1. `.env`ファイルで`OPENAI_API_KEY`が正しく設定されているか確認
2. ネットワーク接続を確認
3. APIキーの有効性を確認
4. レート制限に達していないか確認（しばらく待ってから再試行）

### 処理時間が長い場合

**警告**: `処理時間が5秒を超過しました`

**対応**:
- 検索結果数(k)を減らす
- データ量が多い場合はチャンクサイズを調整
- ネットワーク状況を確認

## ファイル構成

```
ai-security-runbook-rag/
├── main.py              # Streamlitメインアプリ
├── initialize.py        # インデックス構築
├── retriever.py         # ハイブリッド検索
├── guardrails.py        # ガードレール（危険操作検知等）
├── logger.py            # ログ記録
├── components.py        # UIコンポーネント
├── utils.py             # ユーティリティ関数
├── constants.py         # 定数定義
├── error_handler.py     # エラーハンドリング
├── judge.py             # 評価処理
├── requirements.txt     # 依存パッケージ
├── .env.example         # 環境変数テンプレート
├── .gitignore
├── data/                # 手順書ファイル格納フォルダ
│   ├── sample_manual.md
│   └── incident_response.md
├── logs/                # ログファイル（JSONL形式）
│   └── query_YYYY-MM-DD.jsonl
├── eval/                # 評価データ
│   ├── eval_dataset.json
│   └── evaluation_results_YYYY-MM-DD.json
└── chroma_db/           # ChromaDBデータ（自動生成）
```

## ログと監査

### ログファイル

- **保存先**: `logs/query_YYYY-MM-DD.jsonl`
- **形式**: JSONL（1行1エントリ）
- **内容**: 
  - タイムスタンプ
  - セッションID
  - 質問と回答
  - 検索結果（スコア、引用元）
  - 処理時間（latency_ms）
  - トークン使用量とコスト
  - 警告理由（warning_reason）

### ログの確認方法

```bash
# 今日のログを確認
cat logs/query_$(date +%Y-%m-%d).jsonl | jq .

# 特定の日付のログを確認
cat logs/query_2024-12-29.jsonl | jq .
```

## 完了条件の確認

以下の機能が正常に動作することを確認してください：

- ✅ 質問→回答→引用（ファイル名>見出し>抜粋）が表示される
- ✅ ハイブリッド検索（BM25 0.6 / vector 0.4、k=4）で動く
- ✅ スコア最高値<0.5 で「該当する手順が見つかりませんでした」と返る
- ✅ 危険操作キーワードで警告バナー＆文言が出る
- ✅ logs/ にJSONLでログが残る
- ✅ 会話履歴が5往復に制限される
- ✅ 引用が折りたたみUIで表示される
- ✅ エラーメッセージが適切に表示される

## 技術スタック

- **UI**: Streamlit
- **RAGフレームワーク**: LangChain
- **ベクトルDB**: ChromaDB
- **検索**: BM25 (rank-bm25) + ベクトル検索
- **LLM**: OpenAI API (gpt-4o-mini)
- **日本語処理**: Sudachi

## ライセンス

（ライセンスを記載）

## 詳細設計

詳細設計書は `DESIGN.md` を参照してください。

## 更新履歴

- 2024-12-29: MVP実装完了
  - 例外処理の追加
  - インデックス再構築の改善（プログレスバー表示）
  - 引用の折りたたみUI実装
  - 会話履歴の制限（5往復）
  - レイテンシ監視（5秒超過警告）

# PDF対応実装完了レポート

## 変更したファイル一覧

1. **constants.py**: PDF処理用の定数を追加
   - `PDF_MAX_HEADING_LEN`, `PDF_MIN_HEADING_LEN`
   - `HEADING_SCORE_THRESHOLD`, `HEADING_SCORE_THRESHOLD_STRICT`
   - `HEADING_PATTERNS`: 見出しパターン（正規表現）
   - `HEADING_KEYWORDS`: 見出しキーワード

2. **utils.py**: PDF処理関数を追加
   - `extract_pdf_pages()`: PDFからページごとにテキスト抽出
   - `normalize_pdf_text()`: PDFテキストのノイズ軽減
   - `score_heading_line()`: 見出し候補のスコアリング
   - `remove_repeated_lines()`: ヘッダー/フッターの除外
   - `pdf_to_sections()`: PDFを見出し推定→セクション化

3. **initialize.py**: PDF処理を統合
   - `load_documents()`: PDFファイルを`pdf_to_sections()`で処理
   - `process_documents()`: PDF由来Documentのチャンキング対応
   - `build_indexes()`: メタデータに`page_start`/`page_end`を追加

4. **components.py**: 引用表示を拡張
   - ページ範囲（`page_start`/`page_end`）を表示
   - 「ファイル名 > 見出し (pX-Y) > 抜粋」形式

5. **retriever.py**: 検索結果にページ情報を追加
   - `search_with_scores()`: メタデータから`page_start`/`page_end`を取得

6. **error_handler.py**: PDFエラー表示を改善
   - スキャンPDFエラーを特別に表示

## 実装内容の詳細

### 見出し推定ロジック

1. **スコアリング方式**
   - 文字数チェック（4-60文字）: +1点
   - 句点で終わらない: +1点
   - 記号が少ない（20%未満）: +1点
   - パターンマッチング: +3点
   - キーワード含有: +1点

2. **閾値調整**
   - 通常: `HEADING_SCORE_THRESHOLD` (3点)
   - 見出し候補が多すぎる場合: `HEADING_SCORE_THRESHOLD_STRICT` (5点)

3. **フォールバック**
   - 見出しが2つ未満の場合、ページ単位でセクション化
   - 見出しは "PAGE {n}" 形式

### テキスト整形

- 連続スペースを1つに正規化
- 行末ハイフン分割（"-\n"）を結合
- 連続改行を2つまでに圧縮
- ヘッダー/フッター（3回以上出現する行）を除外

### メタデータ拡張

PDF由来のDocumentには以下を追加：
- `page_start`: セクション開始ページ（1始まり）
- `page_end`: セクション終了ページ（1始まり）

## 簡単なテスト手順

### ステップ1: PDFファイルの準備

```bash
# data/フォルダにPDFファイルを配置
cp /path/to/your/manual.pdf data/
```

### ステップ2: インデックス再構築

1. Streamlitアプリを起動: `streamlit run main.py`
2. サイドバーから「🔄 インデックス再構築」ボタンをクリック
3. プログレスバーで処理状況を確認
4. エラーがある場合は警告が表示される

### ステップ3: PDF内の見出しで質問

1. メインエリアのチャット入力欄に質問を入力
   - 例: 「第1章の内容を教えて」
   - 例: 「インシデント対応手順について」
2. 回答が生成されることを確認

### ステップ4: 引用表示の確認

1. 回答の下にある「📚 引用元」を展開
2. 引用にページ範囲が表示されることを確認
   - 例: 「見出し: 第1章 概要 (p1-3)」
   - 例: 「見出し: PAGE 5」

### ステップ5: エラーケースの確認

1. **スキャンPDF（画像のみ）**:
   - テキスト抽出できないPDFを配置
   - 警告「このPDFはテキスト抽出できませんでした（スキャンPDFの可能性）」が表示されることを確認

2. **見出しが取れないPDF**:
   - 見出しパターンが少ないPDFを配置
   - ページ単位でセクション化され、「PAGE {n}」形式で表示されることを確認

## 拡張案

### 1. OCR対応（スキャンPDF対応）

- **ライブラリ**: Tesseract OCR + pytesseract
- **実装内容**:
  - PDFから画像を抽出
  - OCRでテキスト化
  - 既存の見出し推定ロジックを適用
- **注意点**: 処理時間が長くなる、精度に依存

### 2. レイアウト解析

- **ライブラリ**: pdfplumber, PyMuPDF (fitz)
- **実装内容**:
  - フォントサイズ、太字、位置情報から見出しを推定
  - より正確な見出し抽出が可能
- **メリット**: ヒューリスティックより精度が高い

### 3. 表・図の抽出

- **ライブラリ**: pdfplumber, camelot-py
- **実装内容**:
  - PDF内の表を抽出して構造化
  - 図のキャプションを抽出
  - メタデータに表・図の情報を追加

### 4. 多段階見出しの階層化

- **実装内容**:
  - 見出しの階層（章→節→項）を推定
  - メタデータに`heading_level`を追加
  - 引用表示で階層を表示

### 5. PDF更新検知

- **実装内容**:
  - ファイルの更新日時を監視
  - 変更があったPDFのみ再インデックス化
  - 差分更新の実装

### 6. パスワード保護PDF対応

- **実装内容**:
  - パスワードを環境変数や設定ファイルから取得
  - パスワード保護PDFの読み込み対応

### 7. 見出し推定の機械学習化

- **実装内容**:
  - 見出し/非見出しの学習データを収集
  - 分類モデルを構築
  - スコアリング方式からML方式に移行

## 注意事項

1. **pypdfのインストール**: `pip install pypdf` が必要
2. **処理時間**: PDFファイルが大きい場合、インデックス構築に時間がかかる
3. **メモリ使用量**: 大きなPDFファイルはメモリを多く使用する可能性がある
4. **見出し推定の精度**: ヒューリスティック方式のため、PDFの構造によっては精度が低下する可能性がある




